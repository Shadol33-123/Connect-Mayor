import{u as h,r as x,h as v,b as _,e as f,j as r,s as d}from"./index-DNQbeVAn.js";import{F as w}from"./FriendCard-CzsQ0rKb.js";import{S as j}from"./Skeleton-CGa9HBs8.js";import{C as b}from"./Card-BcRLNdqC.js";function N(t,u,c){if(u===c)return"self";const i=t.find(a=>a.requester_id===u&&a.receiver_id===c||a.receiver_id===u&&a.requester_id===c);return i?i.status==="accepted"?"accepted":i.status==="pending"&&i.requester_id===u?"outgoing":i.status==="pending"&&i.receiver_id===u?"incoming":i.status==="rejected"?"rejected":"none":"none"}function $(){var p;const{user:t}=h(),[u,c]=x.useState(""),i=v(),a=x.useMemo(()=>u.trim().toLowerCase(),[u]),l=_({queryKey:["community-search",a],queryFn:async()=>{if(!a)return[];const{data:e,error:s}=await d.from("users_profile").select("user_id, username, display_name, avatar_url, total_xp, bio").or(`username.ilike.%${a}%,display_name.ilike.%${a}%`).order("total_xp",{ascending:!1}).limit(40);if(s)throw s;return e||[]}}),m=_({queryKey:["community-requests"],queryFn:async()=>{if(!t)return[];const{data:e,error:s}=await d.from("friend_requests").select("id, requester_id, receiver_id, status").or(`requester_id.eq.${t.id},receiver_id.eq.${t.id}`);if(s)throw s;return e||[]},enabled:!!t}),q=f({mutationFn:async e=>{var n;if(!t)throw new Error("No auth");const{error:s}=await d.from("friend_requests").insert({requester_id:t.id,receiver_id:e,status:"pending"});if(s)throw s;await d.from("notifications").insert({title:"Solicitud de amistad",body:`Has recibido una solicitud de @${(n=t.email)==null?void 0:n.split("@")[0]}`,user_id:e})},onSuccess:()=>{i.invalidateQueries({queryKey:["community-requests"]})}}),g=f({mutationFn:async e=>{const{data:s,error:n}=await d.from("friend_requests").select("requester_id").eq("id",e).single();if(n)throw n;const{error:o}=await d.from("friend_requests").update({status:"accepted"}).eq("id",e);if(o)throw o;s&&await d.from("notifications").insert({title:"Amistad aceptada",body:"¡Ahora son amigos!",user_id:s.requester_id})},onSuccess:()=>{i.invalidateQueries({queryKey:["community-requests"]})}}),y=f({mutationFn:async e=>{const{error:s}=await d.from("friend_requests").update({status:"rejected"}).eq("id",e);if(s)throw s},onSuccess:()=>{i.invalidateQueries({queryKey:["community-requests"]})}});return r.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-8",children:[r.jsxs("div",{className:"space-y-3",children:[r.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Comunidad"}),r.jsx("p",{className:"text-sm text-slate-600",children:"Explora perfiles y expande tu red profesional. Construye conexiones de valor."}),r.jsxs("div",{className:"relative",children:[r.jsx("input",{value:u,onChange:e=>c(e.target.value),placeholder:"Buscar por usuario (@username) o nombre completo",className:"w-full px-4 py-3 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"}),l.isFetching&&r.jsx("span",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-[11px] text-slate-500",children:"Buscando..."})]})]}),r.jsxs(b,{className:"rounded-2xl p-6",children:[l.isLoading&&r.jsx(j,{className:"h-24 w-full rounded-xl"}),!l.isLoading&&(((p=l.data)==null?void 0:p.length)||0)===0&&a&&r.jsxs("div",{className:"text-sm text-slate-500",children:["Sin resultados para “",a,"”."]}),r.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6",children:(l.data||[]).map(e=>{const s=N(m.data||[],(t==null?void 0:t.id)||"",e.user_id);return r.jsx(w,{userId:e.user_id,username:e.username,displayName:e.display_name,avatarUrl:e.avatar_url,xp:e.total_xp,bio:void 0,hideBio:!0,state:t?s:"none",onSend:s==="none"?()=>q.mutate(e.user_id):void 0,onAccept:s==="incoming"?()=>{const n=(m.data||[]).find(o=>o.requester_id===e.user_id&&o.receiver_id===(t==null?void 0:t.id)&&o.status==="pending");n&&g.mutate(n.id)}:void 0,onReject:s==="incoming"?()=>{const n=(m.data||[]).find(o=>o.requester_id===e.user_id&&o.receiver_id===(t==null?void 0:t.id)&&o.status==="pending");n&&y.mutate(n.id)}:void 0,link:`/u/${e.username}`},e.user_id)})})]})]})}export{$ as default};
