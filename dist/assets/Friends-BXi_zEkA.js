import{j as e,c as m,r as x,u as w,h as C,b as q,e as f,B as h,s as l,R as S}from"./index-DNQbeVAn.js";import{C as j}from"./Card-BcRLNdqC.js";import{S as k}from"./Skeleton-CGa9HBs8.js";function F({title:s,children:r,defaultOpen:c}){const[t,a]=x.useState(!!c),d=x.useId();return e.jsxs("div",{className:"border rounded-xl bg-white",children:[e.jsxs("button",{className:m("w-full flex items-center justify-between px-4 py-3 text-left rounded-xl",t?"bg-slate-50":""),"aria-expanded":t,"aria-controls":`sect-${d}`,onClick:()=>a(p=>!p),children:[e.jsx("span",{className:"font-medium text-slate-800",children:s}),e.jsx("span",{className:m("transition",t?"rotate-180":""),"aria-hidden":!0,children:"âŒ„"})]}),e.jsx("div",{id:`sect-${d}`,role:"region",className:m("px-4 pb-4",t?"block":"hidden"),children:r})]})}function R({children:s,className:r}){return e.jsx("div",{className:m("space-y-2",r),children:s})}function D(){var y,g;const{user:s}=w(),[r,c]=x.useState(""),t=C(),a=A(r,350),d=q({queryKey:["friends-search",a],queryFn:async()=>{if(!a)return[];const{data:i,error:n}=await l.from("users_profile").select("user_id, username, display_name, total_xp").or(`username.ilike.%${a}%,display_name.ilike.%${a}%`).order("total_xp",{ascending:!1}).limit(50);if(n)throw n;return i||[]}}),p=q({queryKey:["friend-requests"],queryFn:async()=>{if(!s)return[];const{data:i,error:n}=await l.from("friend_requests").select("id, requester_id, receiver_id, status").or(`requester_id.eq.${s.id},receiver_id.eq.${s.id}`);if(n)throw n;return i||[]},enabled:!!s}),N=f({mutationFn:async i=>{if(!s)throw new Error("No auth");const{error:n}=await l.from("friend_requests").insert({requester_id:s.id,receiver_id:i,status:"pending"});if(n)throw n},onSuccess:()=>{t.invalidateQueries({queryKey:["friend-requests"]})}}),_=f({mutationFn:async i=>{const{error:n}=await l.from("friend_requests").update({status:"accepted"}).eq("id",i);if(n)throw n},onSuccess:()=>{t.invalidateQueries({queryKey:["friend-requests"]})}}),b=f({mutationFn:async i=>{const{error:n}=await l.from("friend_requests").update({status:"rejected"}).eq("id",i);if(n)throw n},onSuccess:()=>{t.invalidateQueries({queryKey:["friend-requests"]})}}),v=x.useMemo(()=>Q(d.data||[]),[d.data]);return e.jsxs("div",{className:"max-w-5xl mx-auto p-6 space-y-6",children:[e.jsxs("header",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Descubre y agrega amigos"}),e.jsx("span",{className:"text-2xl","aria-hidden":!0,children:"ðŸ§­"})]}),e.jsx(j,{className:"rounded-2xl p-4",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸ§­"}),e.jsx("input",{value:r,onChange:i=>c(i.target.value),placeholder:"Buscar por usuario o nombre",className:"flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})}),d.isLoading&&e.jsx(k,{className:"h-20 w-full rounded-xl"}),!d.isLoading&&(((y=d.data)==null?void 0:y.length)??0)>0&&e.jsx(R,{children:Object.entries(v).map(([i,n])=>e.jsx(F,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-7 h-7 rounded-full bg-slate-100 grid place-items-center font-bold text-slate-700",children:i}),e.jsxs("span",{children:["Cercanos a â€œ",a,"â€"]})]}),children:e.jsx("div",{className:"space-y-2",children:n.map(u=>{const o=$(p.data||[],(s==null?void 0:s.id)||"",u.user_id);return e.jsxs(j,{className:"p-3 rounded-xl flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"font-semibold",children:["@",u.username]}),e.jsxs("span",{className:"text-xs text-slate-500",children:[u.display_name||"â€”"," â€¢ ",u.total_xp," XP"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[o.type==="self"&&e.jsx("span",{className:"text-xs text-slate-400",children:"TÃº"}),o.type==="none"&&e.jsx(h,{className:"text-sm",onClick:()=>N.mutate(u.user_id),children:"Agregar"}),o.type==="outgoing"&&e.jsx("span",{className:"text-xs text-slate-500",children:"Solicitud enviada"}),o.type==="incoming"&&e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"text-sm",onClick:()=>_.mutate(o.requestId),children:"Aceptar"}),e.jsx(h,{className:"text-sm",variant:"ghost",onClick:()=>b.mutate(o.requestId),children:"Rechazar"})]}),o.type==="accepted"&&e.jsx("span",{className:"text-xs text-emerald-600",children:"Amigos"})]})]},u.user_id)})})},i))}),!d.isLoading&&a&&(((g=d.data)==null?void 0:g.length)??0)===0&&e.jsx(j,{className:"p-4 rounded-xl text-sm text-slate-500",children:"Sin resultados."})]})}function A(s,r){const[c,t]=x.useState(s);return S.useEffect(()=>{const a=setTimeout(()=>t(s),r);return()=>clearTimeout(a)},[s,r]),c}function Q(s){var c;const r={};for(const t of s){const a=(((c=t.username)==null?void 0:c[0])||"â€¢").toUpperCase();r[a]=r[a]||[],r[a].push(t)}return r}function $(s,r,c){if(r===c)return{type:"self"};const t=s.find(a=>a.requester_id===r&&a.receiver_id===c||a.receiver_id===r&&a.requester_id===c);return t?t.status==="accepted"?{type:"accepted"}:t.requester_id===r&&t.status==="pending"?{type:"outgoing"}:t.receiver_id===r&&t.status==="pending"?{type:"incoming",requestId:t.id}:{type:"none"}:{type:"none"}}export{D as default};
