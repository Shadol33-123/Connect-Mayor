import{j as e,u as P,r as i,v as w,a as z,N as F,s as x,f as J}from"./index-DNQbeVAn.js";function k(r){let n=0;const o=[];if(!r)return{score:n,label:"Vacía",suggestions:["Ingresa una contraseña"]};const d=r.length,l=/[a-z]/.test(r),m=/[A-Z]/.test(r),c=/\d/.test(r),h=/[^a-zA-Z0-9]/.test(r);return d>=8&&n++,d>=12&&n++,l&&m&&n++,c&&h&&n++,(!l||!m)&&o.push("Usa mayúsculas y minúsculas"),c||o.push("Agrega números"),h||o.push("Agrega símbolos"),d<12&&o.push("Usa 12+ caracteres"),{score:n,label:["Muy débil","Débil","Media","Fuerte","Muy fuerte"][n],suggestions:o}}function Z(r){const n=k(r);return r.length>=8&&n.score>=2}function q({password:r}){const{score:n,label:o,suggestions:d}=k(r);return e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx("div",{className:"flex gap-1",children:Array.from({length:4}).map((m,c)=>e.jsx("div",{className:`h-2 flex-1 rounded ${c<n?"bg-green-500":"bg-slate-200"} transition`},c))}),e.jsxs("div",{className:"text-xs flex items-center gap-2",children:[e.jsx("span",{className:n>=3?"text-green-600":n>=1?"text-orange-600":"text-red-600",children:o}),r&&n<3&&e.jsx("span",{className:"text-[10px] text-slate-500 truncate max-w-[60%]",children:d.slice(0,3).join(" · ")})]})]})}function B(r){return J(r)}function G(){const{signIn:r,signUp:n,user:o,loading:d}=P(),[l,m]=i.useState("login"),[c,h]=i.useState(""),[p,A]=i.useState(""),[_,D]=i.useState(""),[S,I]=i.useState(""),[g,L]=i.useState(""),[C,V]=i.useState(""),[u,O]=i.useState(""),[y,N]=i.useState(null);k(p);const M=Z(p),E=!u||w(u),U=!u||z(u),[j,b]=i.useState(null),[W,T]=i.useState(!1),[v,$]=i.useState(!1);i.useEffect(()=>{if(l!=="register")return;let t=!0;async function a(){T(!0);try{const s=g.toLowerCase();if(!s||s.length<3){$(!1);return}const{data:f}=await x.from("users_profile").select("user_id").ilike("username",s).limit(1);if(!t)return;$(!!(f&&f.length>0))}finally{T(!1)}}return a(),()=>{t=!1}},[g,l]);const R=i.useMemo(()=>/^[a-z0-9_]{3,20}$/i.test(g||""),[g]);return i.useEffect(()=>{async function t(){if(!o)return;const a=localStorage.getItem("pending_profile");if(a)try{const s=JSON.parse(a),{data:f}=await x.from("users_profile").select("username").eq("user_id",o.id).single();if(f!=null&&f.username){localStorage.removeItem("pending_profile");return}s.username&&(!s.rut||w(s.rut))&&(await x.from("users_profile").upsert({user_id:o.id,username:s.username,first_name:s.first_name||null,last_name:s.last_name||null,age:typeof s.age=="number"?s.age:null,rut:s.rut||null,display_name:`${s.first_name||""} ${s.last_name||""}`.trim()||null}),localStorage.removeItem("pending_profile"))}catch{}}t()},[o]),o?e.jsx(F,{to:"/profile",replace:!0}):e.jsxs("div",{className:"max-w-md mx-auto py-10",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:l==="login"?"Ingresar":l==="register"?"Crear cuenta":"Restablecer contraseña"}),l==="forgot"?e.jsxs("form",{className:"space-y-4",onSubmit:async t=>{t.preventDefault(),N(null),b(null);try{const{error:a}=await x.auth.signInWithOtp({email:c,options:{emailRedirectTo:window.location.origin+"/profile"}});if(a)throw a;b("Te enviamos un enlace mágico a tu correo. Ábrelo para ingresar automáticamente.")}catch(a){N((a==null?void 0:a.message)??"No se pudo enviar el email")}},children:[e.jsx("input",{className:"w-full border rounded px-3 py-2",type:"email",placeholder:"Email",value:c,onChange:t=>h(t.target.value)}),y&&e.jsx("div",{className:"text-red-600 text-sm",children:y}),j&&e.jsx("div",{className:"text-green-700 text-sm",children:j}),e.jsx("button",{disabled:d,type:"submit",className:"w-full bg-blue-600 text-white rounded py-2 disabled:opacity-50",children:d?"Enviando...":"Enviar enlace"}),e.jsx("button",{type:"button",onClick:()=>m("login"),className:"w-full text-sm text-slate-600 underline",children:"Volver a ingresar"})]}):e.jsxs("form",{className:"space-y-4",onSubmit:async t=>{t.preventDefault(),N(null),b(null);try{if(l==="register"){if(!R)throw new Error("Usuario inválido (letras, números, _; largo 3-20).");if(u&&!w(u))throw new Error("RUT inválido (debe tener 8 o 9 dígitos antes del DV y DV correcto).");if(v)throw new Error("El usuario ya está ocupado.");await n(c,p);const a=(await x.auth.getSession()).data.session,s={username:g.toLowerCase(),first_name:_,last_name:S,age:typeof C=="number"?C:null,rut:u};if(a!=null&&a.user){if(u&&!w(u))throw new Error("RUT inválido (debe tener 8 o 9 dígitos antes del DV y DV correcto).");await x.from("users_profile").upsert({user_id:a.user.id,username:s.username,first_name:s.first_name||null,last_name:s.last_name||null,age:s.age,rut:s.rut||null,display_name:`${_} ${S}`.trim()||null}),b("Cuenta creada e iniciada."),m("login")}else localStorage.setItem("pending_profile",JSON.stringify(s)),b("Cuenta creada. Revisa tu correo para confirmar y luego se completará tu perfil."),m("login")}else await r(c,p)}catch(a){N((a==null?void 0:a.message)??"Error al procesar")}},children:[e.jsx("input",{className:"w-full border rounded px-3 py-2",type:"email",placeholder:"Email",value:c,onChange:t=>h(t.target.value)}),e.jsxs("div",{children:[e.jsx("input",{className:"w-full border rounded px-3 py-2",type:"password",placeholder:"Contraseña",value:p,onChange:t=>A(t.target.value)}),e.jsx(q,{password:p})]}),l==="register"&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Nombre",value:_,onChange:t=>D(t.target.value)}),e.jsx("input",{className:"w-full border rounded px-3 py-2",placeholder:"Apellido",value:S,onChange:t=>I(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("input",{className:`w-full border rounded px-3 py-2 ${g&&(!R||v)?"border-red-400":""}`,placeholder:"Usuario público (único)",value:g,onChange:t=>L(t.target.value.toLowerCase())}),e.jsx("div",{className:"text-xs mt-1",children:e.jsx("span",{className:v?"text-red-600":"text-slate-500",children:v?"El usuario ya está ocupado":`Tu URL pública será /u/${g||"usuario"}`})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{className:"w-full border rounded px-3 py-2",type:"number",min:0,placeholder:"Edad",value:C,onChange:t=>V(t.target.value===""?"":Number(t.target.value))}),e.jsxs("div",{children:[e.jsx("input",{className:`w-full border rounded px-3 py-2 ${u&&(!E||!U)?"border-red-400":""}`,placeholder:"RUT (x.xxx.xxx-x)",value:u,onChange:t=>O(B(t.target.value))}),u&&(!U||!E)&&e.jsx("div",{className:"text-xs text-red-600 mt-1",children:"RUT inválido (8-9 dígitos + DV correcto)"})]})]})]}),y&&e.jsx("div",{className:"text-red-600 text-sm",children:y}),j&&e.jsx("div",{className:"text-green-700 text-sm",children:j}),e.jsx("button",{disabled:d||l==="register"&&(!M||!U||!E||v||!R),type:"submit",className:"w-full bg-blue-600 text-white rounded py-2 disabled:opacity-50",children:d?l==="register"?"Creando...":"Ingresando...":l==="register"?"Crear cuenta":"Entrar"}),e.jsxs("div",{className:"flex gap-2 text-sm justify-between",children:[e.jsx("button",{type:"button",onClick:()=>m(l==="register"?"login":"register"),className:"text-slate-600 underline",children:l==="register"?"Ya tengo cuenta, ingresar":"No tengo cuenta, crear una"}),e.jsx("button",{type:"button",onClick:()=>m("forgot"),className:"text-slate-600 underline",children:"Olvidé mi contraseña"})]})]})]})}export{G as default};
