import{u as Z,g as ee,h as se,r as u,i as K,b as P,e as v,j as e,k as te,P as k,B as x,L as S,s as d,R as ae}from"./index-DNQbeVAn.js";import{g as re,R as ie}from"./RankBadge-B6GHI0D6.js";import{C as c}from"./Card-BcRLNdqC.js";import{S as N}from"./Skeleton-CGa9HBs8.js";import{F as Q}from"./FriendCard-CzsQ0rKb.js";import"./ProgressBar-DsJwVye4.js";function ne(a,f){const[m,o]=u.useState(a);return ae.useEffect(()=>{const _=setTimeout(()=>o(a),f);return()=>clearTimeout(_)},[a,f]),m}function me(){var V;const{user:a}=Z(),f=ee(),m=se(),[o,_]=u.useState(!1),[B,$]=u.useState(!1),[E,O]=u.useState(""),[M,X]=u.useState(1),[w,D]=u.useState("xp"),y=ne(E,350),R=20,s=f.data,b=(s==null?void 0:s.display_name)||((V=a==null?void 0:a.email)==null?void 0:V.split("@")[0])||"Usuario",I=(s==null?void 0:s.banner_style)||"ocean",F=K.find(t=>t.id===I)||K[0],z=o?!!(s!=null&&s.show_progress):!0,H=o?!!(s!=null&&s.show_achievements):!0,G=o?!!(s!=null&&s.show_personal):!0,q=u.useMemo(()=>re((s==null?void 0:s.total_xp)||0),[s==null?void 0:s.total_xp]),g=P({queryKey:["friends-accepted"],queryFn:async()=>{if(!a)return[];const{data:t,error:i}=await d.from("friend_requests").select("requester_id, receiver_id, status").or(`requester_id.eq.${a.id},receiver_id.eq.${a.id}`).eq("status","accepted");if(i)throw i;const r=(t||[]).map(h=>h.requester_id===a.id?h.receiver_id:h.requester_id);if(r.length===0)return[];const{data:l,error:j}=await d.from("users_profile").select("user_id, username, display_name, avatar_url, total_xp").in("user_id",r);if(j)throw j;return l||[]},staleTime:3e4}),n=P({queryKey:["friend-search",y],queryFn:async()=>{const t=y.trim().toLowerCase();if(!t)return null;const{data:i,error:r}=await d.from("users_profile").select("user_id, username, display_name, avatar_url, total_xp, bio").or(`username.ilike.%${t}%,display_name.ilike.%${t}%`).order("total_xp",{ascending:!1}).limit(1);if(r)throw r;return i&&i.length>0?i[0]:null},enabled:!!y}),p=P({queryKey:["friend-requests-mini"],queryFn:async()=>{if(!a)return[];const{data:t,error:i}=await d.from("friend_requests").select("id, requester_id, receiver_id, status").or(`requester_id.eq.${a.id},receiver_id.eq.${a.id}`);if(i)throw i;return t||[]},enabled:!!a,staleTime:15e3});function Y(t){const r=(p.data||[]).find(l=>l.requester_id===(a==null?void 0:a.id)&&l.receiver_id===t||l.receiver_id===(a==null?void 0:a.id)&&l.requester_id===t);return r?r.status==="accepted"?"accepted":r.status==="pending"&&r.requester_id===(a==null?void 0:a.id)?"outgoing":r.status==="pending"&&r.receiver_id===(a==null?void 0:a.id)?"incoming":r.status==="rejected"?"rejected":"none":"none"}const J=v({mutationFn:async t=>{if(!a)throw new Error("No auth");const{error:i}=await d.from("friend_requests").insert({requester_id:a.id,receiver_id:t,status:"pending"});if(i)throw i;const{error:r}=await d.from("notifications").insert({title:"Solicitud de amistad",body:`Has recibido una solicitud de @${(s==null?void 0:s.username)||"usuario"}`,user_id:t});r&&console.warn("Notif error",r.message)},onSuccess:()=>{m.invalidateQueries({queryKey:["friend-requests-mini"]})}}),A=v({mutationFn:async t=>{const{data:i,error:r}=await d.from("friend_requests").select("requester_id, receiver_id").eq("id",t).single();if(r)throw r;const{error:l}=await d.from("friend_requests").update({status:"accepted"}).eq("id",t);if(l)throw l;i&&await d.from("notifications").insert({title:"Amistad aceptada",body:`@${(s==null?void 0:s.username)||"usuario"} aceptÃ³ tu solicitud`,user_id:i.requester_id})},onSuccess:()=>m.invalidateQueries({queryKey:["friend-requests-mini"]})}),T=v({mutationFn:async t=>{const{error:i}=await d.from("friend_requests").update({status:"rejected"}).eq("id",t);if(i)throw i},onSuccess:()=>m.invalidateQueries({queryKey:["friend-requests-mini"]})}),W=v({mutationFn:async t=>{if(!a)throw new Error("No auth");const{data:i,error:r}=await d.from("friend_requests").select("id, requester_id, receiver_id, status").or(`requester_id.eq.${a.id},receiver_id.eq.${a.id}`).eq("status","accepted");if(r)throw r;const l=(i||[]).find(h=>h.requester_id===a.id&&h.receiver_id===t||h.receiver_id===a.id&&h.requester_id===t);if(!l)throw new Error("RelaciÃ³n no encontrada");const{error:j}=await d.from("friend_requests").update({status:"rejected"}).eq("id",l.id);if(j)throw j},onSuccess:()=>m.invalidateQueries({queryKey:["friend-requests-mini"]})}),L=u.useMemo(()=>(p.data||[]).filter(t=>t.receiver_id===(a==null?void 0:a.id)&&t.status==="pending"),[p.data,a==null?void 0:a.id]),U=u.useMemo(()=>{const t=(g.data||[]).slice();return w==="xp"?t.sort((i,r)=>(r.total_xp||0)-(i.total_xp||0)):t.sort((i,r)=>(i.display_name||"").localeCompare(r.display_name||""))},[g.data,w]);return e.jsxs("div",{className:"min-h-screen bg-slate-50",children:[e.jsx("header",{className:`relative bg-gradient-to-r ${F.gradient} ${F.texture} overflow-hidden full-bleed`,children:e.jsx("div",{className:"max-w-6xl mx-auto px-6 py-10 md:py-14 text-white",children:f.isLoading?e.jsxs("div",{className:"flex gap-4 items-end",children:[e.jsx(N,{className:"w-24 h-24 rounded-2xl"}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsx(N,{className:"h-8 w-2/3"}),e.jsx(N,{className:"h-5 w-1/2"})]})]}):e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end gap-5",children:[e.jsx("div",{className:"w-24 h-24 rounded-2xl shadow-xl overflow-hidden grid place-items-center bg-white",children:(()=>{const t=te((s==null?void 0:s.avatar_url)||null);return t.type==="url"?e.jsx("img",{src:t.url,alt:b,className:"w-full h-full object-cover"}):t.type==="preset"?e.jsx("div",{className:`w-full h-full ${t.preset.bg} grid place-items-center text-3xl`,children:t.preset.icon}):e.jsx("div",{className:"w-full h-full grid place-items-center text-3xl font-bold text-slate-700",children:(b[0]||"U").toUpperCase()})})()}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-black leading-tight",children:b}),e.jsxs("p",{className:"text-white/90 text-sm md:text-base flex items-center gap-2",children:["@",(s==null?void 0:s.username)||"usuario"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 sm:ml-auto",children:[e.jsx(k,{children:e.jsxs(x,{className:"bg-white text-slate-800 hover:bg-blue-50 px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2",children:[e.jsx("span",{"aria-hidden":!0,children:"âœï¸"}),e.jsx("span",{children:"Editar perfil"})]})}),(s==null?void 0:s.username)&&e.jsx(S,{to:`/u/${s.username}`,children:e.jsxs(x,{variant:"ghost",className:"bg-white/10 text-white border border-white/30 hover:bg-white/20 px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸŒ"}),e.jsx("span",{children:"Ver pÃºblico"})]})})]})]})})}),e.jsxs("main",{className:"max-w-6xl mx-auto px-6 py-8 space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-slate-600",children:["Vista: ",o?"PÃºblica (como otros te ven)":"Privada (solo tÃº)"]}),e.jsxs("label",{className:"text-sm inline-flex items-center gap-2 cursor-pointer select-none",children:[e.jsx("span",{children:"Vista pÃºblica"}),e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:o,onChange:t=>_(t.target.checked)}),e.jsx("span",{className:"w-11 h-6 bg-gray-200 rounded-full relative after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:w-5 after:h-5 after:bg-white after:rounded-full after:transition-all peer-checked:after:translate-x-full peer-checked:bg-blue-600"})]})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs(c,{className:"rounded-2xl p-5 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-slate-500",children:"Rango"}),e.jsx("div",{className:"mt-2",children:e.jsx(ie,{xp:(s==null?void 0:s.total_xp)||0})})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xs text-slate-500",children:"XP total"}),e.jsx("div",{className:"text-lg font-bold",children:(s==null?void 0:s.total_xp)||0})]})]}),e.jsxs(c,{className:"rounded-2xl p-5",children:[e.jsx("div",{className:"text-xs text-slate-500 mb-1",children:"Privacidad"}),e.jsxs("ul",{className:"text-sm text-slate-700 space-y-1",children:[e.jsxs("li",{children:["Progreso: ",s!=null&&s.show_progress?"Visible":"Oculto"]}),e.jsxs("li",{children:["Logros: ",s!=null&&s.show_achievements?"Visible":"Oculto"]}),e.jsxs("li",{children:["Datos personales: ",s!=null&&s.show_personal?"Visible":"Oculto"]})]})]}),e.jsx(c,{className:"rounded-2xl p-5 flex items-center justify-center text-slate-600 text-sm",children:"Consejo: MantÃ©n tu perfil profesional y claro. AÃ±ade una bio breve y elige un banner acorde."})]}),e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-2",children:"PresentaciÃ³n"}),e.jsx("p",{className:"text-sm text-slate-700",children:(s==null?void 0:s.bio)||"AÃºn no has escrito tu presentaciÃ³n. Usa â€œEditar perfilâ€ para completarla."})]}),e.jsxs("section",{className:"grid md:grid-cols-3 gap-4",children:[e.jsx(C,{icon:"ðŸ–¼ï¸",title:"Cambiar banner",description:"Elige uno de los 5 estilos predefinidos desde el editor.",action:e.jsx(k,{children:e.jsx(x,{className:"mt-3 text-sm",children:"Abrir editor"})})}),e.jsx(C,{icon:"ðŸ‘¤",title:"Cambiar avatar",description:"Selecciona uno de los 5 avatares iniciales o sube una URL.",action:e.jsx(k,{children:e.jsx(x,{className:"mt-3 text-sm",children:"Abrir editor"})})}),e.jsx(C,{icon:"ðŸ”’",title:"Privacidad",description:"Controla quÃ© ven otros: progreso, logros y datos personales.",action:e.jsx(S,{to:"/settings",children:e.jsx(x,{className:"mt-3 text-sm",variant:"ghost",children:"Abrir configuraciÃ³n"})})})]}),e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h2",{className:"text-lg font-semibold mb-3",children:"Tu perfil pÃºblico"}),e.jsx("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:s!=null&&s.username?e.jsxs(e.Fragment,{children:[e.jsx(S,{to:`/u/${s.username}`,children:e.jsxs(x,{variant:"ghost",className:"px-4 py-2 rounded-full border border-slate-200 hover:bg-slate-50",children:[e.jsx("span",{"aria-hidden":!0,children:"ðŸŒ"}),e.jsx("span",{className:"ml-2 font-semibold",children:"Ver pÃºblico"})]})}),e.jsxs("a",{className:"text-blue-600 hover:underline",href:`/u/${s.username}`,children:["/u/",s.username]}),e.jsx("button",{className:"text-xs text-slate-500 hover:text-slate-700",onClick:()=>{navigator.clipboard.writeText(`${window.location.origin}/u/${s.username}`),$(!0),setTimeout(()=>$(!1),1500)},children:B?"Â¡Copiado!":"Copiar enlace"}),"share"in navigator&&e.jsx("button",{className:"text-xs text-slate-500 hover:text-slate-700",onClick:()=>{var t;return(t=navigator.share)==null?void 0:t.call(navigator,{title:b,url:`${window.location.origin}/u/${s.username}`})},children:"Compartir"})]}):e.jsx("span",{className:"text-slate-500",children:"AÃºn no tienes un nombre de usuario. Ve a ConfiguraciÃ³n para definirlo."})})]}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h3",{className:"text-base font-semibold mb-2",children:"Progreso"}),z?e.jsxs("div",{className:"text-sm text-slate-700",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Total XP"}),e.jsx("span",{className:"font-semibold",children:(s==null?void 0:s.total_xp)||0})]}),q.next&&e.jsxs("div",{className:"text-[11px] text-slate-500 mt-1",children:["Faltan ",q.remaining," XP para ",q.next.label]})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"Progreso oculto (segÃºn tu configuraciÃ³n)."})]}),e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h3",{className:"text-base font-semibold mb-2",children:"Logros"}),H?e.jsxs("div",{className:"flex flex-wrap gap-3 text-sm text-slate-700",children:[e.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-50 border",children:"ðŸ Primera lecciÃ³n"}),e.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-50 border",children:"ðŸ“š 5 lecciones"}),e.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-50 border",children:"âš¡ 100 XP"})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"Logros ocultos (segÃºn tu configuraciÃ³n)."})]}),e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h3",{className:"text-base font-semibold mb-2",children:"Datos personales"}),G?e.jsxs("ul",{className:"text-sm text-slate-700 space-y-1",children:[(s==null?void 0:s.age)!==null&&(s==null?void 0:s.age)!==void 0&&e.jsxs("li",{children:["Edad: ",s.age]}),(s==null?void 0:s.rut)&&e.jsxs("li",{children:["RUT: ",s.rut]}),!(s!=null&&s.age)&&!(s!=null&&s.rut)&&e.jsx("li",{className:"text-slate-500",children:"Sin datos ingresados."})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"Datos personales ocultos (segÃºn tu configuraciÃ³n)."})]})]}),e.jsxs(c,{className:"rounded-2xl p-6",children:[e.jsx("h3",{className:"text-base font-semibold mb-2",children:"Enlaces"}),!o||s!=null&&s.show_links?e.jsxs("ul",{className:"text-sm text-blue-600 space-y-2",children:[(s==null?void 0:s.website)&&e.jsx("li",{children:e.jsx("a",{href:s.website,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ðŸŒ Sitio web"})}),(s==null?void 0:s.linkedin)&&e.jsx("li",{children:e.jsx("a",{href:s.linkedin,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ðŸ’¼ LinkedIn"})}),(s==null?void 0:s.github)&&e.jsx("li",{children:e.jsx("a",{href:s.github,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ðŸ™ GitHub"})}),(s==null?void 0:s.portfolio)&&e.jsx("li",{children:e.jsx("a",{href:s.portfolio,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ðŸŽ¨ Portfolio"})}),!(s!=null&&s.website)&&!(s!=null&&s.linkedin)&&!(s!=null&&s.github)&&!(s!=null&&s.portfolio)&&e.jsx("li",{className:"text-slate-500",children:"AÃºn no agregas enlaces."})]}):e.jsx("div",{className:"text-sm text-slate-500",children:"Enlaces ocultos (segÃºn tu configuraciÃ³n)."})]}),e.jsxs(c,{className:"rounded-2xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Amigos"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{value:E,onChange:t=>O(t.target.value),placeholder:"Buscar usuario (@username)",className:"px-3 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"}),n.isFetching&&e.jsx("span",{className:"text-xs text-slate-500",children:"Buscando..."})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{children:"Ordenar amigos:"}),e.jsxs("select",{value:w,onChange:t=>D(t.target.value),className:"border rounded px-2 py-1",children:[e.jsx("option",{value:"xp",children:"Por XP"}),e.jsx("option",{value:"name",children:"Por nombre"})]})]}),g.isLoading?e.jsx(N,{className:"h-24 w-full rounded-xl"}):e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:[U.slice(0,M*R).map(t=>e.jsx(Q,{userId:t.user_id,username:t.username,displayName:t.display_name,avatarUrl:t.avatar_url,xp:t.total_xp,state:"accepted",compact:!0,onRemove:()=>W.mutate(t.user_id),link:`/u/${t.username}`},t.user_id)),U.length===0&&e.jsx("div",{className:"col-span-full text-sm text-slate-500",children:"AÃºn no tienes amigos aceptados."})]}),n.data&&e.jsx(Q,{userId:n.data.user_id,username:n.data.username,displayName:n.data.display_name,avatarUrl:n.data.avatar_url,xp:n.data.total_xp,bio:n.data.bio,state:(()=>{const t=Y(n.data.user_id);return a&&a.id===n.data.user_id?"self":t})(),onSend:()=>{n.data&&J.mutate(n.data.user_id)},onAccept:()=>{if(!n.data)return;const t=(p.data||[]).find(i=>i.requester_id===n.data.user_id&&i.receiver_id===(a==null?void 0:a.id));t&&A.mutate(t.id)},onReject:()=>{if(!n.data)return;const t=(p.data||[]).find(i=>i.requester_id===n.data.user_id&&i.receiver_id===(a==null?void 0:a.id));t&&T.mutate(t.id)},link:`/u/${n.data.username}`}),(g.data||[]).length>R&&e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(x,{variant:"ghost",className:"text-xs",onClick:()=>X(t=>t+1),children:"Ver mÃ¡s"})})]}),L.length>0&&e.jsxs(c,{className:"rounded-2xl p-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Solicitudes entrantes"}),e.jsx("div",{className:"space-y-2",children:L.map(t=>{var l;const i=t.requester_id,r=(g.data||[]).find(j=>j.user_id===i);return e.jsxs("div",{className:"flex items-center justify-between border rounded-lg p-3 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-slate-100 grid place-items-center text-sm font-bold text-slate-700",children:((l=r==null?void 0:r.display_name)==null?void 0:l[0])||"U"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("span",{className:"text-sm font-semibold",children:["@",(r==null?void 0:r.username)||"usuario"]}),e.jsx("span",{className:"text-xs text-slate-500",children:(r==null?void 0:r.display_name)||"â€”"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(x,{className:"text-xs",onClick:()=>A.mutate(t.id),children:"Aceptar"}),e.jsx(x,{variant:"ghost",className:"text-xs",onClick:()=>T.mutate(t.id),children:"Rechazar"})]})]},t.id)})})]})]})]})}function C({icon:a,title:f,description:m,action:o}){return e.jsxs(c,{className:"rounded-2xl p-5",children:[e.jsx("div",{className:"text-2xl","aria-hidden":!0,children:a}),e.jsx("div",{className:"font-semibold mt-2",children:f}),e.jsx("div",{className:"text-sm text-slate-600 mt-1",children:m}),o]})}export{me as default};
