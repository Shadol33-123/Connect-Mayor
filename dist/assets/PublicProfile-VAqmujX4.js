import{d as S,u as $,h as F,b as w,e as _,j as s,k,B as g,s as l}from"./index-DNQbeVAn.js";import{g as E,R as C}from"./RankBadge-B6GHI0D6.js";import{S as A}from"./Skeleton-CGa9HBs8.js";import{C as n}from"./Card-BcRLNdqC.js";import"./ProgressBar-DsJwVye4.js";function K(d,r,c){if(!r||!c)return"none";if(r===c)return"self";const e=d.find(o=>o.requester_id===r&&o.receiver_id===c||o.receiver_id===r&&o.requester_id===c);return e?e.status==="accepted"?"accepted":e.status==="pending"&&e.requester_id===r?"outgoing":e.status==="pending"&&e.receiver_id===r?"incoming":e.status==="rejected"?"rejected":"none":"none"}function T(){const{username:d}=S(),{user:r}=$(),c=F(),{data:e,isLoading:o,error:q}=w({queryKey:["public-profile",d],queryFn:async()=>{if(!d)return null;const{data:t,error:i}=await l.from("users_profile").select("user_id,username,display_name,first_name,last_name,age,rut,total_xp,bio,banner_style,avatar_url,website,linkedin,github,portfolio,show_links,show_achievements,show_progress,show_personal").ilike("username",d).single();if(i)throw i;return t},enabled:!!d}),j=w({queryKey:["public-friends-top",e==null?void 0:e.user_id],queryFn:async()=>{if(!(e!=null&&e.user_id))return[];const{data:t,error:i}=await l.from("friend_requests").select("requester_id, receiver_id, status").or(`requester_id.eq.${e.user_id},receiver_id.eq.${e.user_id}`).eq("status","accepted");if(i)throw i;const a=(t||[]).map(N=>N.requester_id===e.user_id?N.receiver_id:N.requester_id);if(a.length===0)return[];const{data:h,error:m}=await l.from("users_profile").select("user_id, username, display_name, avatar_url, total_xp").in("user_id",a).order("total_xp",{ascending:!1}).limit(5);if(m)throw m;return h||[]},enabled:!!(e!=null&&e.user_id)}),x=w({queryKey:["public-profile-requests",e==null?void 0:e.user_id,r==null?void 0:r.id],queryFn:async()=>{if(!r||!(e!=null&&e.user_id))return[];const{data:t,error:i}=await l.from("friend_requests").select("id,requester_id,receiver_id,status").or(`and(requester_id.eq.${r.id},receiver_id.eq.${e.user_id}),and(requester_id.eq.${e.user_id},receiver_id.eq.${r.id})`).limit(1);if(i)throw i;return t||[]},enabled:!!r&&!!(e!=null&&e.user_id)}),v=_({mutationFn:async()=>{var i;if(!r||!(e!=null&&e.user_id))return;const{error:t}=await l.from("friend_requests").insert({requester_id:r.id,receiver_id:e.user_id,status:"pending"});if(t)throw t;try{await l.from("notifications").insert({title:"Solicitud de amistad",body:`Has recibido una solicitud de @${(i=r.email)==null?void 0:i.split("@")[0]}`,user_id:e.user_id})}catch{}},onSuccess:()=>{c.invalidateQueries({queryKey:["public-profile-requests",e==null?void 0:e.user_id,r==null?void 0:r.id]})}}),P=_({mutationFn:async t=>{var h;const{error:i}=await l.from("friend_requests").update({status:"accepted"}).eq("id",t);if(i)throw i;const a=(h=x.data)==null?void 0:h.find(m=>m.id===t);if(a)try{await l.from("notifications").insert({title:"Amistad aceptada",body:"Â¡Ahora son amigos!",user_id:a.requester_id})}catch{}},onSuccess:()=>{c.invalidateQueries({queryKey:["public-profile-requests",e==null?void 0:e.user_id,r==null?void 0:r.id]})}}),R=_({mutationFn:async t=>{const{error:i}=await l.from("friend_requests").update({status:"rejected"}).eq("id",t);if(i)throw i},onSuccess:()=>{c.invalidateQueries({queryKey:["public-profile-requests",e==null?void 0:e.user_id,r==null?void 0:r.id]})}}),y=_({mutationFn:async()=>{if(!r||!(e!=null&&e.user_id))return;const t=(x.data||[]).find(a=>a.status==="accepted");if(!t)return;const{error:i}=await l.from("friend_requests").update({status:"rejected"}).eq("id",t.id);if(i)throw i},onSuccess:()=>{c.invalidateQueries({queryKey:["public-profile-requests",e==null?void 0:e.user_id,r==null?void 0:r.id]})}});if(o)return s.jsx("div",{className:"p-6",children:s.jsx(A,{className:"h-32 w-full"})});if(q)return s.jsx("div",{className:"p-6 text-red-600",children:q.message});if(!e)return s.jsx("div",{className:"p-6 text-slate-600",children:"Perfil no encontrado."});const b=[e.first_name,e.last_name].filter(Boolean).join(" ")||e.display_name||e.username||"Usuario",u=K(x.data||[],(r==null?void 0:r.id)||"",e.user_id),p=E(e.total_xp),f=p.next;return s.jsxs("div",{className:"min-h-screen bg-slate-50",children:[s.jsx("header",{className:"relative bg-gradient-to-r from-indigo-500 to-cyan-500 overflow-hidden full-bleed",children:s.jsxs("div",{className:"max-w-5xl mx-auto px-6 py-12 text-white flex flex-col sm:flex-row gap-6",children:[s.jsx("div",{className:"w-24 h-24 rounded-2xl shadow-xl overflow-hidden grid place-items-center",children:(()=>{const t=k(e.avatar_url);return t.type==="url"?s.jsx("img",{src:t.url,alt:b,className:"w-full h-full object-cover"}):t.type==="preset"?s.jsx("div",{className:`w-full h-full ${t.preset.bg} grid place-items-center text-4xl`,children:t.preset.icon}):s.jsx("div",{className:"w-full h-full grid place-items-center text-3xl font-bold text-slate-700",children:(b[0]||"U").toUpperCase()})})()}),s.jsxs("div",{className:"flex-1 flex flex-col gap-3",children:[s.jsx("h1",{className:"text-3xl font-black leading-tight",children:b}),s.jsxs("p",{className:"text-white/90 text-sm",children:["@",e.username," â€¢ ",p.current.label,f&&` â€¢ faltan ${p.remaining} XP para ${f.label}`]}),e.bio&&s.jsx("p",{className:"text-sm text-white/80 max-w-xl",children:e.bio}),r&&u!=="self"&&s.jsxs("div",{className:"mt-2",children:[u==="none"&&s.jsx(g,{onClick:()=>v.mutate(),disabled:v.status==="pending",className:"text-xs",children:"Agregar amigo"}),u==="outgoing"&&s.jsx("span",{className:"text-xs bg-white/20 px-3 py-1 rounded-full",children:"Solicitud enviada"}),u==="incoming"&&s.jsxs("div",{className:"flex gap-2 flex-wrap",children:[s.jsx(g,{onClick:()=>{const t=(x.data||[]).find(i=>i.status==="pending"&&i.requester_id===e.user_id);t&&P.mutate(t.id)},className:"text-xs",children:"Aceptar"}),s.jsx(g,{variant:"ghost",onClick:()=>{const t=(x.data||[]).find(i=>i.status==="pending"&&i.requester_id===e.user_id);t&&R.mutate(t.id)},className:"text-xs",children:"Rechazar"})]}),u==="accepted"&&s.jsx(g,{variant:"ghost",onClick:()=>y.mutate(),disabled:y.status==="pending",className:"text-xs",children:"Eliminar amigo"}),u==="rejected"&&s.jsx("span",{className:"text-xs text-red-200",children:"Rechazado"})]})]})]})}),s.jsxs("main",{className:"max-w-5xl mx-auto px-6 py-10 space-y-10",children:[s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Rango"}),s.jsx(C,{xp:e.total_xp})]}),e.show_progress?s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Progreso"}),s.jsxs("p",{className:"text-sm text-slate-600",children:["XP total: ",e.total_xp]}),f&&s.jsxs("p",{className:"text-xs text-slate-500 mt-1",children:["Faltan ",p.remaining," XP para ",f.label]})]}):s.jsx(n,{className:"p-6 rounded-2xl",children:s.jsx("p",{className:"text-sm text-slate-500",children:"El usuario ocultÃ³ su progreso."})}),e.show_achievements?s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Logros"}),s.jsxs("div",{className:"flex flex-wrap gap-3 text-sm text-slate-700",children:[s.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-100 border",children:"ğŸ Primera lecciÃ³n"}),s.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-100 border",children:"ğŸ“š 5 lecciones"}),s.jsx("span",{className:"px-3 py-2 rounded-xl bg-slate-100 border",children:"âš¡ 100 XP"})]})]}):s.jsx(n,{className:"p-6 rounded-2xl",children:s.jsx("p",{className:"text-sm text-slate-500",children:"Logros ocultos."})}),e.show_personal?s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Datos"}),s.jsxs("ul",{className:"text-sm text-slate-700 space-y-1",children:[e.age!==null&&s.jsxs("li",{children:["Edad: ",e.age]}),e.rut&&s.jsxs("li",{children:["RUT: ",e.rut]})]})]}):s.jsx(n,{className:"p-6 rounded-2xl text-sm text-slate-500",children:"Datos personales ocultos."}),j.data&&j.data.length>0&&s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Amigos destacados"}),s.jsx("div",{className:"flex flex-wrap gap-4",children:j.data.map(t=>s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-10 h-10 rounded-xl bg-slate-100 overflow-hidden grid place-items-center text-sm font-bold text-slate-700",children:(()=>{var a;const i=k(t.avatar_url);return i.type==="url"?s.jsx("img",{src:i.url,className:"w-full h-full object-cover"}):i.type==="preset"?s.jsx("div",{className:`w-full h-full ${i.preset.bg} grid place-items-center text-xl`,children:i.preset.icon}):((a=t.display_name)==null?void 0:a[0])||"U"})()}),s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("span",{className:"text-sm font-semibold",children:["@",t.username]}),s.jsxs("span",{className:"text-[11px] text-slate-500",children:[t.total_xp," XP"]})]})]},t.user_id))})]})]}),s.jsx("section",{className:"max-w-5xl mx-auto px-6 pb-12",children:e.show_links?s.jsxs(n,{className:"p-6 rounded-2xl",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4",children:"Enlaces"}),s.jsxs("ul",{className:"text-sm text-blue-600 space-y-2",children:[e.website&&s.jsx("li",{children:s.jsx("a",{href:e.website,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ğŸŒ Sitio web"})}),e.linkedin&&s.jsx("li",{children:s.jsx("a",{href:e.linkedin,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ğŸ’¼ LinkedIn"})}),e.github&&s.jsx("li",{children:s.jsx("a",{href:e.github,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ğŸ™ GitHub"})}),e.portfolio&&s.jsx("li",{children:s.jsx("a",{href:e.portfolio,target:"_blank",className:"hover:underline",rel:"noreferrer",children:"ğŸ¨ Portfolio"})}),!e.website&&!e.linkedin&&!e.github&&!e.portfolio&&s.jsx("li",{className:"text-slate-500",children:"Sin enlaces publicados."})]})]}):s.jsx(n,{className:"p-6 rounded-2xl text-sm text-slate-500",children:"Enlaces ocultos."})})]})}export{T as default};
